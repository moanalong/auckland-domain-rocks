<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- EXTREME cache busting for mobile browsers -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0, private, proxy-revalidate">
    <meta http-equiv="Pragma" content="no-cache, no-store">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Last-Modified" content="Mon, 13 Jan 2025 00:00:00 GMT">
    <meta name="cache-control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta name="expires" content="0">
    <meta name="pragma" content="no-cache">
    <!-- iOS Safari EXTREME cache busting -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-version" content="1757759200">
    <meta name="theme-color" content="#3498db">
    <!-- Force Safari to reload everything -->
    <meta name="version" content="1757759200-photo-upload-feature">
    <meta name="build" content="1757759200">
    <meta name="cache-buster" content="1757759200">
    <title>Auckland Domain Rock Hunter - Find Hidden Rocks!</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css?v=1757759200&photo-upload=complete&cache-bust=force&mobile=extreme">
    <script>
        // EXTREME AGGRESSIVE CACHE BUSTING - Permanent Solution
        (function() {
            const APP_VERSION = '1757759200-photo-upload-feature';
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            
            console.log('Cache Buster: Starting with version', APP_VERSION);

            // Service Worker Registration for Cache Control
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js', { scope: '/' })
                    .then(registration => {
                        console.log('SW: Registered successfully');
                        
                        // Listen for service worker messages
                        navigator.serviceWorker.addEventListener('message', event => {
                            if (event.data.type === 'CACHE_CLEARED') {
                                console.log('SW: Received cache cleared message');
                                setTimeout(() => window.location.reload(true), 100);
                            }
                        });
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            console.log('SW: Update found, installing new service worker');
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed') {
                                    console.log('SW: New service worker installed');
                                    if (navigator.serviceWorker.controller) {
                                        // New content available
                                        forceAppRefresh();
                                    }
                                }
                            });
                        });
                    })
                    .catch(err => console.warn('SW: Registration failed', err));
            }

            // Version Detection and Auto-Update
            function checkVersion() {
                const lastVersion = localStorage.getItem('auckland_app_version');
                const lastCheck = localStorage.getItem('auckland_last_check');
                const now = Date.now();
                
                console.log('Version Check: Last =', lastVersion, 'Current =', APP_VERSION);
                
                if (lastVersion !== APP_VERSION || (now - parseInt(lastCheck)) > 300000) { // 5 minutes
                    console.log('Version Update: Clearing all caches and data');
                    localStorage.setItem('auckland_app_version', APP_VERSION);
                    localStorage.setItem('auckland_last_check', now.toString());
                    
                    // Nuclear cache clearing
                    clearAllCaches().then(() => {
                        if (lastVersion !== APP_VERSION) {
                            setTimeout(() => window.location.reload(true), 200);
                        }
                    });
                }
            }

            // Nuclear Cache Clearing Function
            async function clearAllCaches() {
                console.log('Nuclear Cache Clear: Starting total cache obliteration');
                
                // 1. Clear all browser caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => {
                        console.log('Deleting cache:', name);
                        return caches.delete(name);
                    }));
                }
                
                // 2. Clear session storage
                sessionStorage.clear();
                
                // 3. Clear specific localStorage items (keep user accounts)
                const keysToKeep = ['auckland-rock-users', 'auckland-rock-current-user'];
                const allKeys = Object.keys(localStorage);
                allKeys.forEach(key => {
                    if (!keysToKeep.includes(key) && !key.startsWith('auckland_app_')) {
                        localStorage.removeItem(key);
                    }
                });
                
                // 4. iOS Safari specific clearing
                if (isIOS) {
                    try {
                        // Force DOM reload
                        document.documentElement.style.display = 'none';
                        document.documentElement.offsetHeight; // Trigger reflow
                        document.documentElement.style.display = '';
                    } catch (e) {
                        console.warn('iOS force reflow failed:', e);
                    }
                }
                
                console.log('Nuclear Cache Clear: Complete');
            }

            // Force App Refresh
            function forceAppRefresh() {
                console.log('Force Refresh: Initiating app refresh');
                
                // Send message to service worker
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'FORCE_REFRESH'
                    });
                } else {
                    clearAllCaches().then(() => {
                        window.location.reload(true);
                    });
                }
            }

            // Manual Refresh Button for Mobile
            function addRefreshButton() {
                document.addEventListener('DOMContentLoaded', function() {
                    if (isMobile) {
                        const header = document.querySelector('header .controls');
                        if (header) {
                            const refreshBtn = document.createElement('button');
                            refreshBtn.innerHTML = 'üîÑ Force Refresh';
                            refreshBtn.className = 'btn refresh-btn';
                            refreshBtn.title = 'Clear all caches and reload app';
                            refreshBtn.onclick = function() {
                                console.log('Manual Refresh: User initiated');
                                localStorage.removeItem('auckland_app_version');
                                forceAppRefresh();
                            };
                            header.appendChild(refreshBtn);
                        }
                    }
                });
            }

            // Initialize everything
            checkVersion();
            addRefreshButton();

            // Double-check version on focus (when user returns to app)
            window.addEventListener('focus', () => {
                setTimeout(checkVersion, 1000);
            });

            // Check version every 2 minutes
            setInterval(checkVersion, 120000);

        })();
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1><div class="header-rock"></div>Auckland Domain Rock Hunter</h1>
            <div class="controls">
                <button id="toggle-view" class="btn">üìç View All Rocks</button>
                <button id="add-rock-mode" class="btn">‚ûï Add Rock</button>
                <div id="user-section" class="user-section">
                    <!-- User authentication buttons will be added here by JavaScript -->
                </div>
            </div>
        </header>

        <main>
            <!-- Statistics Dashboard -->
            <div id="stats-dashboard" class="stats-panel">
                <h3>üìä Auckland Domain Rock Stats</h3>
                <div id="stats-container">
                    <div class="stat-item">
                        <span class="stat-number">0</span>
                        <span class="stat-label">Total Rocks</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">0</span>
                        <span class="stat-label">Still Hidden</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">0</span>
                        <span class="stat-label">Found</span>
                    </div>
                </div>
            </div>

            <!-- Search and Filter Panel -->
            <div id="search-panel" class="panel">
                <h3>üîç Search & Filter Rocks</h3>
                <div class="search-controls">
                    <input type="text" id="search-input" placeholder="Search by rock name or description...">
                    
                    <div class="filter-row">
                        <select id="status-filter">
                            <option value="all">All Rocks</option>
                            <option value="hidden">Hidden Only</option>
                            <option value="found">Found Only</option>
                        </select>
                        
                        <select id="date-filter">
                            <option value="all">All Time</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="recent">Last 3 Days</option>
                        </select>
                    </div>
                    
                    <div class="filter-actions">
                        <button id="apply-filters" class="btn primary">Apply Filters</button>
                        <button id="clear-filters" class="btn">Clear All</button>
                    </div>
                </div>
            </div>

            <div id="map" class="map-container"></div>
            
            <div id="rock-panel" class="panel hidden">
                <h3>Hidden Rocks</h3>
                <div id="rocks-list"></div>
                <button id="close-panel" class="btn">Close</button>
            </div>

            <div id="add-rock-modal" class="modal hidden">
                <div class="modal-content">
                    <h3>Add New Rock</h3>
                    <form id="rock-form">
                        <input type="text" id="rock-name" placeholder="Rock name" required>
                        <textarea id="rock-description" placeholder="Description (optional)"></textarea>
                        
                        <div id="posting-toggle" class="posting-toggle hidden">
                            <label class="toggle-label">
                                <input type="checkbox" id="post-as-user" checked>
                                <span class="toggle-text">Post as <span id="current-username"></span></span>
                            </label>
                            <small>Uncheck to post anonymously</small>
                        </div>
                        
                        <div class="photo-section">
                            <div class="photo-options">
                                <button type="button" id="take-photo-option" class="btn photo-option">üì∑ Take Photo</button>
                                <button type="button" id="upload-photo-option" class="btn photo-option">üìÅ Upload Photo</button>
                            </div>
                            
                            <div class="camera-section hidden">
                                <video id="camera-preview" autoplay></video>
                                <canvas id="photo-canvas" style="display: none;"></canvas>
                                <div class="camera-controls">
                                    <button type="button" id="start-camera" class="btn">üì∑ Start Camera</button>
                                    <button type="button" id="take-photo" class="btn hidden">üì∏ Take Photo</button>
                                    <button type="button" id="retake-photo" class="btn hidden">üîÑ Retake</button>
                                    <button type="button" id="cancel-camera" class="btn">‚ùå Cancel</button>
                                </div>
                            </div>
                            
                            <div class="upload-section hidden">
                                <input type="file" id="photo-upload" accept="image/*" capture="environment" style="display: none;">
                                <button type="button" id="choose-file" class="btn">üìÅ Choose from Photos</button>
                                <button type="button" id="cancel-upload" class="btn">‚ùå Cancel</button>
                            </div>
                            
                            <div id="photo-preview" class="photo-preview hidden"></div>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="submit" class="btn primary">Save Rock</button>
                            <button type="button" id="cancel-add" class="btn">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="app.js?v=1757759200&photo-upload=complete&cache-bust=force&mobile=extreme"></script>
</body>
</html>