<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Auckland Domain Rock Hunter - Find Hidden Rocks!</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css?v=1759001111&force-refresh=true">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        .leaflet-container {
            border-radius: 10px;
        }
        .user-location-marker {
            background: #2196F3 !important;
            color: white !important;
            border: 3px solid white !important;
            border-radius: 50% !important;
            width: 40px !important;
            height: 40px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 20px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><div class="header-rock"></div>Auckland Domain Rock Hunter</h1>
            <div class="controls">
                <button id="toggle-view" class="btn fern">üìç View All Rocks</button>
                <button id="add-rock-mode" class="btn cherry">‚ûï Add Rock</button>
                <button id="remove-rock-mode" class="btn cherry">‚ûñ Remove Rock</button>
            </div>
        </header>

        <main>
            <!-- Statistics Dashboard -->
            <div id="stats-dashboard" class="stats-panel">
                <h3>üìä Auckland Domain Rock Stats</h3>
                <div id="stats-container">
                    <div class="stat-item">
                        <span class="stat-number">0</span>
                        <span class="stat-label">Total Rocks</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">0</span>
                        <span class="stat-label">Still Hidden</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">0</span>
                        <span class="stat-label">Found</span>
                    </div>
                </div>
            </div>

            <!-- Nature Divider -->
            <div class="nature-divider"></div>

            <!-- Map Section -->
            <div class="map-section">
                <h3>üó∫Ô∏è Map View</h3>
                <div id="map" class="map-container" style="height: 400px;">
                    <!-- Interactive Leaflet map will be created here -->
                </div>
            </div>

            <div id="rock-panel" class="panel hidden">
                <h3>Hidden Rocks</h3>
                <div id="rocks-list"></div>
                <button id="close-panel" class="btn">Close</button>
            </div>

            <!-- Add Rock Modal -->
            <div id="add-rock-modal" class="modal hidden">
                <div class="modal-content">
                    <h3>‚ûï Add New Rock</h3>
                    <form id="rock-form">
                        <input type="text" id="rock-name" placeholder="Rock name *" required>

                        <textarea id="rock-description" placeholder="Description (optional)" rows="3"></textarea>

                        <input type="text" id="owner-name" placeholder="Your name (optional)">

                        <div class="photo-section">
                            <div class="photo-buttons">
                                <button type="button" id="camera-btn" class="btn maple">üì∑ Take Photo</button>
                                <button type="button" id="gallery-btn" class="btn fantail">üñºÔ∏è Choose Photo</button>
                            </div>

                            <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;">
                            <input type="file" id="gallery-input" accept="image/*" style="display: none;">

                            <div id="photo-preview" class="photo-preview hidden">
                                <img id="preview-image" src="" alt="Photo preview" style="max-width: 100%; height: 200px; object-fit: cover; border-radius: 8px;">
                                <button type="button" id="remove-photo" class="btn secondary" style="margin-top: 10px;">Remove Photo</button>
                            </div>
                        </div>

                        <div class="modal-actions">
                            <button type="submit" class="btn primary">üíæ Save Rock</button>
                            <button type="button" id="cancel-add" class="btn secondary">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let userMarker;
        let rocks = [];
        let addRockMode = false;
        let selectedPhoto = null;
        let db = null;

        // Initialize Firebase
        function initFirebase() {
            try {
                if (typeof firebase !== 'undefined' && window.firebaseDb) {
                    db = window.firebaseDb;
                    console.log('üî• Firebase initialized');
                } else {
                    console.log('‚ö†Ô∏è Firebase not available, using local storage only');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Firebase error:', error);
            }
        }

        // Initialize the map centered on Auckland Domain
        function initMap() {
            console.log('üó∫Ô∏è Initializing map...');

            map = L.map('map').setView([-36.8627, 174.7775], 16);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            console.log('‚úÖ Map initialized');

            // Load existing rocks from local storage
            loadRocks();

            // Start GPS after map is ready
            setTimeout(startGPS, 1000);
        }

        function startGPS() {
            console.log('üåç Starting GPS...');

            if (!navigator.geolocation) {
                alert('‚ùå GPS not supported by your browser');
                return;
            }

            alert('üåç Getting your GPS location...');

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;

                    console.log(`‚úÖ GPS: ${lat}, ${lng} (accuracy: ${accuracy}m)`);
                    alert(`‚úÖ GPS found you at: ${lat.toFixed(6)}, ${lng.toFixed(6)}\nAccuracy: ${accuracy.toFixed(0)}m`);

                    // Add accurate GPS marker to map
                    addAccurateGPSMarker(lat, lng, accuracy);
                },
                function(error) {
                    console.log(`‚ùå GPS Error: ${error.message} (Code: ${error.code})`);
                    let errorMsg = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Location access denied by user';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Location information unavailable';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'Location request timed out';
                            break;
                        default:
                            errorMsg = 'Unknown GPS error';
                    }
                    alert(`‚ùå GPS failed: ${errorMsg}\nTechnical: ${error.message}`);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 20000,
                    maximumAge: 30000
                }
            );
        }

        function addAccurateGPSMarker(lat, lng, accuracy) {
            if (!map) {
                alert('‚ùå Map not ready yet');
                return;
            }

            // Remove existing user marker
            if (userMarker) {
                map.removeLayer(userMarker);
            }

            // Create custom blue marker
            const userIcon = L.divIcon({
                className: 'user-location-marker',
                html: 'üìç',
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });

            // Add marker at exact GPS coordinates
            userMarker = L.marker([lat, lng], { icon: userIcon })
                .addTo(map)
                .bindPopup(`üìç Your Location<br>Accuracy: ${accuracy.toFixed(0)}m`);

            // Pan map to user location
            map.setView([lat, lng], 17);

            // Add accuracy circle
            L.circle([lat, lng], {
                color: '#2196F3',
                fillColor: '#2196F3',
                fillOpacity: 0.2,
                radius: accuracy
            }).addTo(map);

            alert('‚úÖ Accurate GPS marker placed on map!');
        }

        // Rock saving functionality
        function saveRock(rockData) {
            alert('üîç saveRock function called!');

            // Generate unique ID
            const id = 'rock_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            alert(`üîç Generated ID: ${id}`);

            const rock = {
                id: id,
                name: rockData.name,
                description: rockData.description || '',
                ownerName: rockData.ownerName || 'Anonymous',
                date: new Date().toISOString(),
                lat: rockData.lat,
                lng: rockData.lng,
                photo: rockData.photo || null
            };

            alert(`üîç Rock object created: ${JSON.stringify(rock).substring(0, 200)}...`);

            // Save to local storage
            try {
                rocks.push(rock);
                localStorage.setItem('auckland_domain_rocks', JSON.stringify(rocks));
                console.log('üíæ Rock saved locally');
                alert('‚úÖ Rock saved to local storage');
            } catch (error) {
                alert(`‚ùå Local storage error: ${error.message}`);
            }

            // Save to Firebase (if available)
            if (db) {
                alert('üî• Attempting Firebase save...');
                db.collection('rocks').doc(id).set(rock).then(() => {
                    console.log('üî• Rock saved to Firebase');
                    alert('‚úÖ Rock saved to Firebase');
                }).catch((error) => {
                    console.log('‚ö†Ô∏è Firebase save error:', error);
                    alert(`‚ùå Firebase error: ${error.message}`);
                });
            } else {
                alert('‚ö†Ô∏è Firebase not available');
            }

            // Add marker to map
            alert('üîç Adding marker to map...');
            try {
                addRockMarker(rock);
                alert('‚úÖ Marker added to map');
            } catch (error) {
                alert(`‚ùå Marker error: ${error.message}`);
            }

            // Update stats
            alert('üîç Updating stats...');
            try {
                updateStats();
                alert('‚úÖ Stats updated');
            } catch (error) {
                alert(`‚ùå Stats error: ${error.message}`);
            }

            alert(`‚úÖ Rock "${rock.name}" saved successfully!\nDate: ${new Date(rock.date).toLocaleDateString()}`);
        }

        function loadRocks() {
            // Load from local storage
            const localRocks = localStorage.getItem('auckland_domain_rocks');
            if (localRocks) {
                rocks = JSON.parse(localRocks);
                console.log(`üì¶ Loaded ${rocks.length} rocks from local storage`);
            }

            // Load from Firebase (if available)
            if (db) {
                db.collection('rocks').get().then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const firebaseRock = doc.data();
                        // Only add if not already in local storage
                        if (!rocks.find(r => r.id === firebaseRock.id)) {
                            rocks.push(firebaseRock);
                        }
                    });
                    console.log(`üî• Total rocks after Firebase sync: ${rocks.length}`);
                    displayRocks();
                    updateStats();
                }).catch((error) => {
                    console.log('‚ö†Ô∏è Firebase load error:', error);
                    displayRocks();
                    updateStats();
                });
            } else {
                displayRocks();
                updateStats();
            }
        }

        function displayRocks() {
            rocks.forEach(rock => addRockMarker(rock));
        }

        function addRockMarker(rock) {
            const rockIcon = L.divIcon({
                className: 'rock-marker',
                html: '<div class="header-rock"></div>',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            const popupContent = `
                <div class="rock-popup">
                    <h4>${rock.name}</h4>
                    ${rock.description ? `<p>${rock.description}</p>` : ''}
                    <small>Added by: ${rock.ownerName}<br>Date: ${new Date(rock.date).toLocaleDateString()}</small>
                    ${rock.photo ? `<br><img src="${rock.photo}" style="width:100px; height:100px; object-fit:cover; margin-top:5px; border-radius:5px;">` : ''}
                </div>
            `;

            L.marker([rock.lat, rock.lng], { icon: rockIcon })
                .addTo(map)
                .bindPopup(popupContent);
        }

        function updateStats() {
            const totalRocks = rocks.length;
            document.querySelector('.stat-item:nth-child(1) .stat-number').textContent = totalRocks;
            document.querySelector('.stat-item:nth-child(2) .stat-number').textContent = totalRocks; // Assuming all are still hidden
            document.querySelector('.stat-item:nth-child(3) .stat-number').textContent = '0'; // Found counter
        }

        // Photo handling
        function handlePhotoSelection(file) {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedPhoto = e.target.result;
                    document.getElementById('preview-image').src = selectedPhoto;
                    document.getElementById('photo-preview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        // Simple rock list functions
        function toggleRockPanel() {
            const panel = document.getElementById('rock-panel');
            const button = document.getElementById('toggle-view');

            if (panel.classList.contains('hidden')) {
                showRockPanel();
                button.textContent = 'üó∫Ô∏è Show Map';
            } else {
                closeRockPanel();
                button.textContent = 'üìç View All Rocks';
            }
        }

        function showRockPanel() {
            document.getElementById('rock-panel').classList.remove('hidden');
            updateRocksList();
        }

        function closeRockPanel() {
            document.getElementById('rock-panel').classList.add('hidden');
        }

        function updateRocksList() {
            const container = document.getElementById('rocks-list');

            if (rocks.length === 0) {
                container.innerHTML = '<p>No rocks found yet. Start hunting!</p>';
                return;
            }

            container.innerHTML = rocks.map(rock => {
                return `
                    <div class="rock-item">
                        <h4>${rock.name}</h4>
                        ${rock.description ? `<p class="rock-description">${rock.description}</p>` : ''}
                        <div class="rock-meta">
                            <div class="coordinates">
                                üìç ${rock.lat.toFixed(6)}, ${rock.lng.toFixed(6)}
                            </div>
                            <div class="coordinates">
                                üïí ${new Date(rock.date).toLocaleDateString()}
                            </div>
                            <div class="rock-owner">
                                üë§ ${rock.ownerName || 'Anonymous'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // View All Rocks button
            document.getElementById('toggle-view').addEventListener('click', function() {
                toggleRockPanel();
            });

            // Close panel button
            document.getElementById('close-panel').addEventListener('click', function() {
                closeRockPanel();
                document.getElementById('toggle-view').textContent = 'üìç View All Rocks';
            });

            // Add Rock button
            document.getElementById('add-rock-mode').addEventListener('click', function() {
                addRockMode = !addRockMode;
                if (addRockMode) {
                    alert('üìç Tap anywhere on the map to add a rock!');
                    this.textContent = '‚ùå Cancel Add Rock';
                    this.className = 'btn secondary';
                } else {
                    this.textContent = '‚ûï Add Rock';
                    this.className = 'btn cherry';
                }
            });

            // Remove Rock button
            document.getElementById('remove-rock-mode').addEventListener('click', function() {
                if (rocks.length === 0) {
                    alert('No rocks to remove!');
                    return;
                }

                // Show rock selection for removal
                let rockList = 'Select a rock to remove:\n\n';
                rocks.forEach((rock, index) => {
                    rockList += `${index + 1}. ${rock.name} (by ${rock.ownerName})\n`;
                });

                const selection = prompt(rockList + '\nEnter the number of the rock to remove (or cancel):');

                if (selection && !isNaN(selection)) {
                    const rockIndex = parseInt(selection) - 1;
                    if (rockIndex >= 0 && rockIndex < rocks.length) {
                        const rock = rocks[rockIndex];

                        if (confirm(`Are you sure you want to remove "${rock.name}"?`)) {
                            // Remove from array
                            rocks.splice(rockIndex, 1);

                            // Update local storage
                            localStorage.setItem('auckland_domain_rocks', JSON.stringify(rocks));

                            // Remove from Firebase if available
                            if (db) {
                                db.collection('rocks').doc(rock.id).delete().then(() => {
                                    console.log('Rock removed from Firebase');
                                }).catch((error) => {
                                    console.log('Error removing from Firebase:', error);
                                });
                            }

                            // Refresh display
                            if (map) {
                                map.eachLayer(function(layer) {
                                    if (layer instanceof L.Marker) {
                                        map.removeLayer(layer);
                                    }
                                });
                                displayRocks();
                            }

                            updateStats();
                            alert(`‚úÖ Rock "${rock.name}" has been removed!`);
                        }
                    } else {
                        alert('Invalid selection!');
                    }
                }
            });

            // Map click to add rock
            setTimeout(() => {
                if (map) {
                    map.on('click', function(e) {
                        if (addRockMode) {
                            openAddRockModal(e.latlng.lat, e.latlng.lng);
                        }
                    });
                }
            }, 2000);

            // Photo buttons
            document.getElementById('camera-btn').addEventListener('click', function() {
                document.getElementById('camera-input').click();
            });

            document.getElementById('gallery-btn').addEventListener('click', function() {
                document.getElementById('gallery-input').click();
            });

            // Photo inputs
            document.getElementById('camera-input').addEventListener('change', function(e) {
                if (e.target.files[0]) {
                    handlePhotoSelection(e.target.files[0]);
                }
            });

            document.getElementById('gallery-input').addEventListener('change', function(e) {
                if (e.target.files[0]) {
                    handlePhotoSelection(e.target.files[0]);
                }
            });

            // Remove photo
            document.getElementById('remove-photo').addEventListener('click', function() {
                selectedPhoto = null;
                document.getElementById('photo-preview').classList.add('hidden');
                document.getElementById('camera-input').value = '';
                document.getElementById('gallery-input').value = '';
            });

            // Form submission
            document.getElementById('rock-form').addEventListener('submit', function(e) {
                e.preventDefault();
                alert('üîç Save Rock button clicked!');

                const name = document.getElementById('rock-name').value.trim();
                const description = document.getElementById('rock-description').value.trim();
                const ownerName = document.getElementById('owner-name').value.trim();

                alert(`üîç Form data - Name: "${name}", Description: "${description}", Owner: "${ownerName}"`);

                if (!name) {
                    alert('‚ùå Please enter a rock name');
                    return;
                }

                const lat = parseFloat(document.getElementById('rock-form').dataset.lat);
                const lng = parseFloat(document.getElementById('rock-form').dataset.lng);

                alert(`üîç Location data - Lat: ${lat}, Lng: ${lng}`);

                alert('üîç About to save rock...');

                saveRock({
                    name: name,
                    description: description,
                    ownerName: ownerName,
                    lat: lat,
                    lng: lng,
                    photo: selectedPhoto
                });

                // Close modal and reset
                closeAddRockModal();
            });

            // Cancel button
            document.getElementById('cancel-add').addEventListener('click', function() {
                closeAddRockModal();
            });
        });

        function openAddRockModal(lat, lng) {
            document.getElementById('rock-form').dataset.lat = lat;
            document.getElementById('rock-form').dataset.lng = lng;
            document.getElementById('add-rock-modal').classList.remove('hidden');

            // Reset form
            document.getElementById('rock-form').reset();
            selectedPhoto = null;
            document.getElementById('photo-preview').classList.add('hidden');
        }

        function closeAddRockModal() {
            document.getElementById('add-rock-modal').classList.add('hidden');

            // Reset add rock mode
            addRockMode = false;
            const addBtn = document.getElementById('add-rock-mode');
            addBtn.textContent = '‚ûï Add Rock';
            addBtn.className = 'btn cherry';
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            console.log('üî• Page loaded, initializing...');
            initFirebase();
            setTimeout(initMap, 500);
        });
    </script>
</body>
</html>