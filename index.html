<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Auckland Domain Rock Hunter - Find Hidden Rocks!</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css?v=1759001111&force-refresh=true">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        .leaflet-container {
            border-radius: 10px;
        }
        .user-location-marker {
            background: #2196F3 !important;
            color: white !important;
            border: 3px solid white !important;
            border-radius: 50% !important;
            width: 40px !important;
            height: 40px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 20px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><div class="header-rock"></div>Auckland Domain Rock Hunter</h1>
            <div class="controls">
                <button id="toggle-view" class="btn fern">üìç View All Rocks</button>
                <button id="add-rock-mode" class="btn cherry">‚ûï Add Rock</button>
                <button id="remove-rock-mode" class="btn cherry">‚ûñ Remove Rock</button>
            </div>
        </header>

        <main>
            <!-- Mark as Found Button -->
            <div style="text-align: center; margin-bottom: 20px;">
                <button id="mark-found-mode" class="btn fern">üéØ Mark as Found</button>
            </div>

            <!-- Statistics Dashboard -->
            <div id="stats-dashboard" class="stats-panel">
                <h3>üìä Auckland Domain Rock Stats</h3>
                <div id="stats-container">
                    <div class="stat-item">
                        <span class="stat-number">0</span>
                        <span class="stat-label">Total Rocks</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">0</span>
                        <span class="stat-label">Still Hidden</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">0</span>
                        <span class="stat-label">Found</span>
                    </div>
                </div>
            </div>

            <!-- Nature Divider -->
            <div class="nature-divider"></div>

            <!-- Map Section -->
            <div class="map-section">
                <h3>üó∫Ô∏è Map View</h3>
                <div id="map" class="map-container" style="height: 400px;">
                    <!-- Interactive Leaflet map will be created here -->
                </div>
            </div>

            <div id="rock-panel" class="panel hidden">
                <h3>Hidden Rocks</h3>
                <div id="rocks-list"></div>
                <button id="close-panel" class="btn">Close</button>
            </div>

            <!-- Add Rock Modal -->
            <div id="add-rock-modal" class="modal hidden">
                <div class="modal-content">
                    <h3>‚ûï Add New Rock</h3>
                    <form id="rock-form">
                        <input type="text" id="rock-name" placeholder="Rock name *" required>

                        <textarea id="rock-description" placeholder="Description (optional)" rows="3"></textarea>

                        <input type="text" id="owner-name" placeholder="Your name (optional)">

                        <div class="photo-section">
                            <div class="photo-buttons">
                                <button type="button" id="camera-btn" class="btn maple">üì∑ Take Photo</button>
                                <button type="button" id="gallery-btn" class="btn fantail">üñºÔ∏è Choose Photo</button>
                            </div>

                            <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;">
                            <input type="file" id="gallery-input" accept="image/*" style="display: none;">

                            <div id="photo-preview" class="photo-preview hidden">
                                <img id="preview-image" src="" alt="Photo preview" style="max-width: 100%; height: 200px; object-fit: cover; border-radius: 8px;">
                                <button type="button" id="remove-photo" class="btn secondary" style="margin-top: 10px;">Remove Photo</button>
                            </div>
                        </div>

                        <div class="modal-actions">
                            <button type="submit" class="btn primary">üíæ Save Rock</button>
                            <button type="button" id="cancel-add" class="btn secondary">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let userMarker;
        let rocks = [];
        let addRockMode = false;
        let selectedPhoto = null;
        let db = null;

        // Initialize Firebase
        function initFirebase() {
            try {
                if (typeof firebase !== 'undefined' && window.firebaseDb) {
                    db = window.firebaseDb;
                    console.log('üî• Firebase initialized');
                } else {
                    console.log('‚ö†Ô∏è Firebase not available, using local storage only');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Firebase error:', error);
            }
        }

        // Initialize the map centered on Auckland Domain
        function initMap() {
            console.log('üó∫Ô∏è Initializing map...');

            map = L.map('map').setView([-36.8627, 174.7775], 16);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            console.log('‚úÖ Map initialized');

            // Load existing rocks from local storage
            loadRocks();

            // Start GPS after map is ready
            setTimeout(startGPS, 1000);
        }

        function startGPS() {
            console.log('üåç Starting GPS...');

            if (!navigator.geolocation) {
                alert('‚ùå GPS not supported by your browser');
                return;
            }

            alert('üåç Getting your GPS location...');

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;

                    console.log(`‚úÖ GPS: ${lat}, ${lng} (accuracy: ${accuracy}m)`);
                    alert(`‚úÖ GPS found you at: ${lat.toFixed(6)}, ${lng.toFixed(6)}\nAccuracy: ${accuracy.toFixed(0)}m`);

                    // Add accurate GPS marker to map
                    addAccurateGPSMarker(lat, lng, accuracy);
                },
                function(error) {
                    console.log(`‚ùå GPS Error: ${error.message} (Code: ${error.code})`);
                    let errorMsg = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Location access denied by user';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Location information unavailable';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'Location request timed out';
                            break;
                        default:
                            errorMsg = 'Unknown GPS error';
                    }
                    alert(`‚ùå GPS failed: ${errorMsg}\nTechnical: ${error.message}`);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 20000,
                    maximumAge: 30000
                }
            );
        }

        function addAccurateGPSMarker(lat, lng, accuracy) {
            if (!map) {
                alert('‚ùå Map not ready yet');
                return;
            }

            // Remove existing user marker
            if (userMarker) {
                map.removeLayer(userMarker);
            }

            // Create custom blue marker
            const userIcon = L.divIcon({
                className: 'user-location-marker',
                html: 'üìç',
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });

            // Add marker at exact GPS coordinates
            userMarker = L.marker([lat, lng], { icon: userIcon })
                .addTo(map)
                .bindPopup(`üìç Your Location<br>Accuracy: ${accuracy.toFixed(0)}m`);

            // Pan map to user location
            map.setView([lat, lng], 17);

            // Add accuracy circle
            L.circle([lat, lng], {
                color: '#2196F3',
                fillColor: '#2196F3',
                fillOpacity: 0.2,
                radius: accuracy
            }).addTo(map);

            alert('‚úÖ Accurate GPS marker placed on map!');
        }

        // Rock saving functionality
        function saveRock(rockData) {
            console.log('üîç saveRock function called');

            // Generate unique ID
            const id = 'rock_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            const rock = {
                id: id,
                name: rockData.name,
                description: rockData.description || '',
                ownerName: rockData.ownerName || 'Anonymous',
                date: new Date().toISOString(),
                timestamp: new Date().toISOString(),
                lat: rockData.lat,
                lng: rockData.lng,
                photo: rockData.photo || null,
                status: 'hidden',  // Default status
                foundBy: null,
                foundDate: null
            };

            console.log('üîç Rock object created:', rock.name);

            // Check total rock size before saving
            const rockString = JSON.stringify(rock);
            const rockSizeKB = rockString.length / 1024;
            console.log(`üìä Rock data size: ${rockSizeKB.toFixed(2)} KB`);

            if (rockString.length > 600000) { // 600KB limit for Firebase (including overhead)
                alert('‚ùå Rock data is too large to save. Please use a smaller photo or remove the photo.');
                return;
            }

            // Save to Firebase first (this will trigger the real-time listener)
            if (db) {
                console.log('üî• Saving to Firebase...');
                db.collection('rocks').doc(id).set(rock).then(() => {
                    console.log('üî• Rock saved to Firebase successfully');
                    alert(`‚úÖ Rock "${rock.name}" saved and shared with all users!`);
                }).catch((error) => {
                    console.log('‚ö†Ô∏è Firebase save error:', error);
                    alert(`‚ùå Failed to save rock: ${error.message}`);

                    // Fallback: save locally only
                    rocks.push(rock);
                    localStorage.setItem('auckland_domain_rocks', JSON.stringify(rocks));
                    addRockMarker(rock);
                    updateStats();
                    alert(`‚ö†Ô∏è Rock saved locally only (no internet connection)`);
                });
            } else {
                // No Firebase, save locally only
                console.log('‚ö†Ô∏è Firebase not available, saving locally only');
                rocks.push(rock);
                localStorage.setItem('auckland_domain_rocks', JSON.stringify(rocks));
                addRockMarker(rock);
                updateStats();
                alert(`‚ö†Ô∏è Rock saved locally only (Firebase not available)`);
            }
        }

        function loadRocks() {
            // Load from local storage
            const localRocks = localStorage.getItem('auckland_domain_rocks');
            if (localRocks) {
                rocks = JSON.parse(localRocks);
                console.log(`üì¶ Loaded ${rocks.length} rocks from local storage`);
            }

            // Set up real-time Firebase listener (if available)
            if (db) {
                console.log('üî• Setting up real-time Firebase listener...');
                db.collection('rocks').onSnapshot((querySnapshot) => {
                    console.log(`üîÑ Real-time update: ${querySnapshot.size} rocks in Firebase`);

                    // Reset rocks array and rebuild from Firebase
                    rocks = [];
                    querySnapshot.forEach((doc) => {
                        const firebaseRock = { id: doc.id, ...doc.data() };
                        rocks.push(firebaseRock);
                    });

                    console.log(`üî• Updated rocks array: ${rocks.length} rocks`);

                    // Update local storage with latest data
                    localStorage.setItem('auckland_domain_rocks', JSON.stringify(rocks));

                    // Refresh display
                    if (map) {
                        map.eachLayer(function(layer) {
                            if (layer instanceof L.Marker) {
                                map.removeLayer(layer);
                            }
                        });
                        displayRocks();
                    }
                    updateStats();

                }, (error) => {
                    console.log('‚ö†Ô∏è Firebase real-time listener error:', error);
                    // Fallback to local storage only
                    displayRocks();
                    updateStats();
                });
            } else {
                console.log('‚ö†Ô∏è Firebase not available, using local storage only');
                displayRocks();
                updateStats();
            }
        }

        function displayRocks() {
            rocks.forEach(rock => addRockMarker(rock));
        }

        function addRockMarker(rock) {
            // Use pink oval rock icon for found rocks, regular rock icon for hidden rocks
            const rockIcon = L.divIcon({
                className: rock.status === 'found' ? 'rock-marker found-marker' : 'rock-marker',
                html: '<div class="header-rock"></div>',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            // Build popup content with found photo if available
            let popupContent = `
                <div class="rock-popup">
                    <h4>${rock.name}</h4>
                    ${rock.description ? `<p>${rock.description}</p>` : ''}
                    <small>Added by: ${rock.ownerName}<br>Date: ${new Date(rock.date).toLocaleDateString()}</small>
                    ${rock.photo ? `<br><img src="${rock.photo}" style="width:100px; height:100px; object-fit:cover; margin-top:5px; border-radius:5px;">` : ''}
            `;

            if (rock.status === 'found') {
                popupContent += `
                    <div class="found-info">
                        <p class="found-status">‚úÖ Found by ${rock.foundBy} on ${new Date(rock.foundDate).toLocaleDateString()}</p>
                        ${rock.foundPhoto ? `<img src="${rock.foundPhoto}" class="popup-found-photo" style="width:100px; height:100px; object-fit:cover; margin-top:5px; border-radius:5px;" onclick="showPhotoModal('${rock.foundPhoto}')" alt="Found photo">` : ''}
                    </div>
                `;
            }

            popupContent += `</div>`;

            L.marker([rock.lat, rock.lng], { icon: rockIcon })
                .addTo(map)
                .bindPopup(popupContent);
        }

        function updateStats() {
            const totalRocks = rocks.length;
            const foundRocks = rocks.filter(rock => rock.status === 'found').length;
            const hiddenRocks = totalRocks - foundRocks;

            document.querySelector('.stat-item:nth-child(1) .stat-number').textContent = totalRocks;
            document.querySelector('.stat-item:nth-child(2) .stat-number').textContent = hiddenRocks;
            document.querySelector('.stat-item:nth-child(3) .stat-number').textContent = foundRocks;
        }

        // Photo handling with compression
        function handlePhotoSelection(file) {
            if (file && file.type.startsWith('image/')) {
                console.log(`üì∏ Original file size: ${(file.size / 1024 / 1024).toFixed(2)} MB`);

                // Check if file is too large (over 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('‚ö†Ô∏è Photo is too large. Please choose a smaller image (under 5MB).');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // Compress the image
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Set much smaller maximum dimensions for Firebase
                        const maxWidth = 400;
                        const maxHeight = 300;
                        let { width, height } = img;

                        // Calculate new dimensions
                        if (width > height) {
                            if (width > maxWidth) {
                                height = height * (maxWidth / width);
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = width * (maxHeight / height);
                                height = maxHeight;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;

                        // Draw and compress
                        ctx.drawImage(img, 0, 0, width, height);

                        // Start with high compression and reduce quality until it fits
                        let quality = 0.3; // Start with 30% quality
                        let compressedDataUrl = canvas.toDataURL('image/jpeg', quality);

                        // Keep reducing quality until it fits Firebase limit
                        while (compressedDataUrl.length > 500000 && quality > 0.1) { // 500KB limit
                            quality -= 0.05;
                            compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        }

                        console.log(`üì∏ Final compressed size: ${(compressedDataUrl.length / 1024).toFixed(2)} KB at ${(quality * 100).toFixed(0)}% quality`);

                        // Final check - if still too large, offer option to save without photo
                        if (compressedDataUrl.length > 500000) { // 500KB absolute limit
                            const saveWithoutPhoto = confirm('‚ùå Photo is too large even after compression.\n\n‚úÖ Save rock without photo?\n‚ùå Cancel to choose different photo?');
                            if (saveWithoutPhoto) {
                                selectedPhoto = null;
                                document.getElementById('photo-preview').classList.add('hidden');
                                alert('‚úÖ Photo removed. You can now save the rock without a photo.');
                            }
                            return;
                        }

                        selectedPhoto = compressedDataUrl;
                        document.getElementById('preview-image').src = compressedDataUrl;
                        document.getElementById('photo-preview').classList.remove('hidden');

                        console.log('‚úÖ Photo compressed and ready for upload');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // Simple rock list functions
        function toggleRockPanel() {
            const panel = document.getElementById('rock-panel');
            const button = document.getElementById('toggle-view');

            if (panel.classList.contains('hidden')) {
                showRockPanel();
                button.textContent = 'üó∫Ô∏è Show Map';
            } else {
                closeRockPanel();
                button.textContent = 'üìç View All Rocks';
            }
        }

        function showRockPanel() {
            document.getElementById('rock-panel').classList.remove('hidden');
            updateRocksList();
        }

        function closeRockPanel() {
            document.getElementById('rock-panel').classList.add('hidden');
        }

        function updateRocksList() {
            const container = document.getElementById('rocks-list');

            if (rocks.length === 0) {
                container.innerHTML = '<p>No rocks found yet. Start hunting!</p>';
                return;
            }

            container.innerHTML = rocks.map(rock => {
                // Add photo if available
                const photoHtml = rock.photo ?
                    `<div class="rock-photo-container">
                        <img src="${rock.photo}" class="rock-photo" alt="${rock.name}" onclick="showPhotoModal('${rock.photo}')">
                    </div>` : '';

                return `
                    <div class="rock-item">
                        <h4>${rock.name}</h4>
                        ${rock.description ? `<p class="rock-description">${rock.description}</p>` : ''}
                        ${photoHtml}
                        <div class="rock-meta">
                            <div class="coordinates">
                                üìç ${rock.lat.toFixed(6)}, ${rock.lng.toFixed(6)}
                            </div>
                            <div class="coordinates">
                                üïí ${new Date(rock.date).toLocaleDateString()}
                            </div>
                            <div class="rock-owner">
                                üë§ ${rock.ownerName || 'Anonymous'}
                            </div>
                            <div class="rock-status">
                                ${rock.status === 'found'
                                    ? `‚úÖ Found by ${rock.foundBy} on ${new Date(rock.foundDate).toLocaleDateString()}`
                                    : 'üé® Hidden'
                                }
                            </div>
                            ${rock.status === 'found' && rock.foundPhoto ?
                                `<div class="found-photo-container">
                                    <h5>üì∏ Found Photo:</h5>
                                    <img src="${rock.foundPhoto}" class="found-photo" alt="Found photo" onclick="showPhotoModal('${rock.foundPhoto}')">
                                </div>` : ''
                            }
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show photo in full screen modal
        function showPhotoModal(photoUrl) {
            const modal = document.createElement('div');
            modal.className = 'photo-modal';
            modal.innerHTML = `
                <div class="photo-modal-content">
                    <span class="close-photo" onclick="closePhotoModal()">&times;</span>
                    <img src="${photoUrl}" class="modal-photo" alt="Rock photo">
                </div>
            `;
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closePhotoModal();
                }
            };
            document.body.appendChild(modal);
        }

        function closePhotoModal() {
            const modal = document.querySelector('.photo-modal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // Show photo capture modal for marking rock as found
        function showFoundPhotoModal(rock, finderName) {
            const modal = document.createElement('div');
            modal.className = 'found-photo-modal modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>üì∏ Mark "${rock.name}" as Found</h3>
                    <p>Take a photo of the rock to prove you found it!</p>
                    <p><strong>Found by:</strong> ${finderName}</p>

                    <div class="photo-capture-section">
                        <div class="photo-buttons">
                            <button type="button" id="found-camera-btn" class="btn maple">üì∑ Take Photo</button>
                            <button type="button" id="found-gallery-btn" class="btn fantail">üñºÔ∏è Choose Photo</button>
                        </div>

                        <div id="found-photo-preview" class="photo-preview hidden">
                            <img id="found-preview-image" src="" alt="Found photo preview">
                            <button id="found-remove-photo" class="btn secondary">Remove Photo</button>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button id="confirm-found" class="btn fern" disabled>‚úÖ Confirm Found</button>
                        <button id="cancel-found" class="btn secondary">‚ùå Cancel</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            let selectedFoundPhoto = null;

            // Camera button
            document.getElementById('found-camera-btn').addEventListener('click', function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.capture = 'environment';
                input.style.display = 'none';
                input.addEventListener('change', function(e) {
                    if (e.target.files[0]) {
                        handleFoundPhotoSelection(e.target.files[0]);
                    }
                });
                document.body.appendChild(input);
                input.click();
                setTimeout(() => document.body.removeChild(input), 1000);
            });

            // Gallery button
            document.getElementById('found-gallery-btn').addEventListener('click', function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.style.display = 'none';
                input.addEventListener('change', function(e) {
                    if (e.target.files[0]) {
                        handleFoundPhotoSelection(e.target.files[0]);
                    }
                });
                document.body.appendChild(input);
                input.click();
                setTimeout(() => document.body.removeChild(input), 1000);
            });

            // Remove photo
            document.getElementById('found-remove-photo').addEventListener('click', function() {
                selectedFoundPhoto = null;
                document.getElementById('found-photo-preview').classList.add('hidden');
                document.getElementById('confirm-found').disabled = true;
            });

            // Confirm found
            document.getElementById('confirm-found').addEventListener('click', function() {
                if (selectedFoundPhoto) {
                    markRockAsFound(rock, finderName, selectedFoundPhoto);
                    document.body.removeChild(modal);
                } else {
                    alert('‚ùå Photo is required to mark rock as found!');
                }
            });

            // Cancel
            document.getElementById('cancel-found').addEventListener('click', function() {
                document.body.removeChild(modal);
            });

            // Handle photo selection with compression
            function handleFoundPhotoSelection(file) {
                if (file && file.type.startsWith('image/')) {
                    console.log(`üì∏ Found photo - Original size: ${(file.size / 1024 / 1024).toFixed(2)} MB`);

                    if (file.size > 5 * 1024 * 1024) {
                        alert('‚ö†Ô∏è Photo is too large. Please choose a smaller image (under 5MB).');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            // Compress the found photo
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');

                            const maxWidth = 400;
                            const maxHeight = 300;
                            let { width, height } = img;

                            if (width > height) {
                                if (width > maxWidth) {
                                    height = height * (maxWidth / width);
                                    width = maxWidth;
                                }
                            } else {
                                if (height > maxHeight) {
                                    width = width * (maxHeight / height);
                                    height = maxHeight;
                                }
                            }

                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);

                            let quality = 0.3;
                            let compressedDataUrl = canvas.toDataURL('image/jpeg', quality);

                            while (compressedDataUrl.length > 500000 && quality > 0.1) {
                                quality -= 0.05;
                                compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                            }

                            console.log(`üì∏ Found photo compressed: ${(compressedDataUrl.length / 1024).toFixed(2)} KB at ${(quality * 100).toFixed(0)}% quality`);

                            if (compressedDataUrl.length > 500000) {
                                alert('‚ùå Photo cannot be compressed enough. Please choose a smaller image.');
                                return;
                            }

                            selectedFoundPhoto = compressedDataUrl;
                            document.getElementById('found-preview-image').src = compressedDataUrl;
                            document.getElementById('found-photo-preview').classList.remove('hidden');
                            document.getElementById('confirm-found').disabled = false;
                            console.log('‚úÖ Found photo ready for upload');
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        // Mark rock as found with photo
        function markRockAsFound(rock, finderName, foundPhoto) {
            // Find the rock in the main array and update it
            const mainRockIndex = rocks.findIndex(r => r.id === rock.id);
            if (mainRockIndex !== -1) {
                rocks[mainRockIndex].status = 'found';
                rocks[mainRockIndex].foundBy = finderName;
                rocks[mainRockIndex].foundDate = new Date().toISOString();
                rocks[mainRockIndex].foundPhoto = foundPhoto;

                console.log(`üì∏ Marking rock as found with photo (${(foundPhoto.length / 1024).toFixed(2)} KB)`);

                // Update local storage
                localStorage.setItem('auckland_domain_rocks', JSON.stringify(rocks));

                // Update Firebase if available
                if (db) {
                    db.collection('rocks').doc(rock.id).update({
                        status: 'found',
                        foundBy: finderName,
                        foundDate: new Date().toISOString(),
                        foundPhoto: foundPhoto
                    }).then(() => {
                        console.log('üî• Rock marked as found in Firebase with photo');
                        alert(`üéâ "${rock.name}" marked as found by ${finderName} with photo!`);
                    }).catch((error) => {
                        console.log('‚ùå Error updating Firebase:', error);
                        alert(`‚ö†Ô∏è Rock marked as found locally, but failed to sync with Firebase: ${error.message}`);
                    });
                } else {
                    alert(`üéâ "${rock.name}" marked as found by ${finderName} with photo!`);
                }

                // Refresh display
                if (map) {
                    map.eachLayer(function(layer) {
                        if (layer instanceof L.Marker) {
                            map.removeLayer(layer);
                        }
                    });
                    displayRocks();
                }

                updateStats();
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // View All Rocks button
            document.getElementById('toggle-view').addEventListener('click', function() {
                toggleRockPanel();
            });

            // Close panel button
            document.getElementById('close-panel').addEventListener('click', function() {
                closeRockPanel();
                document.getElementById('toggle-view').textContent = 'üìç View All Rocks';
            });

            // Add Rock button
            document.getElementById('add-rock-mode').addEventListener('click', function() {
                addRockMode = !addRockMode;
                if (addRockMode) {
                    alert('üìç Tap anywhere on the map to add a rock!');
                    this.textContent = '‚ùå Cancel Add Rock';
                    this.className = 'btn secondary';
                } else {
                    this.textContent = '‚ûï Add Rock';
                    this.className = 'btn cherry';
                }
            });

            // Remove Rock button
            document.getElementById('remove-rock-mode').addEventListener('click', function() {
                if (rocks.length === 0) {
                    alert('No rocks to remove!');
                    return;
                }

                // Get current user name for ownership check
                const currentUserName = prompt('Please enter your name to verify ownership:');
                if (!currentUserName) {
                    alert('‚ùå Name is required to remove rocks.');
                    return;
                }

                // Filter rocks that can be removed (own rocks that are not found)
                const removableRocks = rocks.filter(rock => {
                    // Check if rock belongs to current user
                    const isOwner = rock.ownerName && rock.ownerName.toLowerCase() === currentUserName.toLowerCase();
                    // Check if rock is not found
                    const isNotFound = rock.status !== 'found';
                    return isOwner && isNotFound;
                });

                if (removableRocks.length === 0) {
                    alert('‚ùå No rocks available for removal!\n\nYou can only remove:\n‚Ä¢ Rocks that you posted\n‚Ä¢ Rocks that have not been found yet');
                    return;
                }

                // Show only removable rocks
                let rockList = 'Your rocks available for removal:\n\n';
                removableRocks.forEach((rock, index) => {
                    rockList += `${index + 1}. ${rock.name} (Hidden since ${new Date(rock.date).toLocaleDateString()})\n`;
                });

                const selection = prompt(rockList + '\nEnter the number of the rock to remove (or cancel):');

                if (selection && !isNaN(selection)) {
                    const rockIndex = parseInt(selection) - 1;
                    if (rockIndex >= 0 && rockIndex < removableRocks.length) {
                        const rock = removableRocks[rockIndex];

                        // Double-check ownership and found status
                        if (rock.ownerName.toLowerCase() !== currentUserName.toLowerCase()) {
                            alert('‚ùå You can only remove rocks that you posted!');
                            return;
                        }

                        if (rock.status === 'found') {
                            alert('‚ùå Cannot remove rocks that have been found!');
                            return;
                        }

                        if (confirm(`Are you sure you want to remove "${rock.name}"?\n\nThis action cannot be undone.`)) {
                            // Find rock in main array and remove it
                            const mainRockIndex = rocks.findIndex(r => r.id === rock.id);
                            if (mainRockIndex !== -1) {
                                rocks.splice(mainRockIndex, 1);

                                // Update local storage
                                localStorage.setItem('auckland_domain_rocks', JSON.stringify(rocks));

                                // Remove from Firebase if available
                                if (db) {
                                    db.collection('rocks').doc(rock.id).delete().then(() => {
                                        console.log('Rock removed from Firebase');
                                    }).catch((error) => {
                                        console.log('Error removing from Firebase:', error);
                                    });
                                }

                                // Refresh display
                                if (map) {
                                    map.eachLayer(function(layer) {
                                        if (layer instanceof L.Marker) {
                                            map.removeLayer(layer);
                                        }
                                    });
                                    displayRocks();
                                }

                                updateStats();
                                alert(`‚úÖ Rock "${rock.name}" has been removed successfully!`);
                            }
                        }
                    } else {
                        alert('Invalid selection!');
                    }
                }
            });

            // Mark as Found button - with photo requirement
            document.getElementById('mark-found-mode').addEventListener('click', function() {
                const hiddenRocks = rocks.filter(rock => rock.status !== 'found');

                if (hiddenRocks.length === 0) {
                    alert('No hidden rocks to mark as found!');
                    return;
                }

                // Show rock selection for marking as found
                let rockList = 'Select a rock to mark as found:\n\n';
                hiddenRocks.forEach((rock, index) => {
                    rockList += `${index + 1}. ${rock.name} (by ${rock.ownerName})\n`;
                });

                const selection = prompt(rockList + '\nEnter the number of the rock you found (or cancel):');

                if (selection && !isNaN(selection)) {
                    const rockIndex = parseInt(selection) - 1;
                    if (rockIndex >= 0 && rockIndex < hiddenRocks.length) {
                        const rock = hiddenRocks[rockIndex];
                        const finderName = prompt(`Who found "${rock.name}"?`, 'Anonymous') || 'Anonymous';

                        // Show photo capture modal for found rock
                        showFoundPhotoModal(rock, finderName);
                    } else {
                        alert('Invalid selection!');
                    }
                }
            });

            // Map click to add rock
            setTimeout(() => {
                if (map) {
                    map.on('click', function(e) {
                        if (addRockMode) {
                            openAddRockModal(e.latlng.lat, e.latlng.lng);
                        }
                    });
                }
            }, 2000);

            // Photo buttons
            document.getElementById('camera-btn').addEventListener('click', function() {
                document.getElementById('camera-input').click();
            });

            document.getElementById('gallery-btn').addEventListener('click', function() {
                document.getElementById('gallery-input').click();
            });

            // Photo inputs
            document.getElementById('camera-input').addEventListener('change', function(e) {
                if (e.target.files[0]) {
                    handlePhotoSelection(e.target.files[0]);
                }
            });

            document.getElementById('gallery-input').addEventListener('change', function(e) {
                if (e.target.files[0]) {
                    handlePhotoSelection(e.target.files[0]);
                }
            });

            // Remove photo
            document.getElementById('remove-photo').addEventListener('click', function() {
                selectedPhoto = null;
                document.getElementById('photo-preview').classList.add('hidden');
                document.getElementById('camera-input').value = '';
                document.getElementById('gallery-input').value = '';
            });

            // Form submission
            document.getElementById('rock-form').addEventListener('submit', function(e) {
                e.preventDefault();
                alert('üîç Save Rock button clicked!');

                const name = document.getElementById('rock-name').value.trim();
                const description = document.getElementById('rock-description').value.trim();
                const ownerName = document.getElementById('owner-name').value.trim();

                alert(`üîç Form data - Name: "${name}", Description: "${description}", Owner: "${ownerName}"`);

                if (!name) {
                    alert('‚ùå Please enter a rock name');
                    return;
                }

                const lat = parseFloat(document.getElementById('rock-form').dataset.lat);
                const lng = parseFloat(document.getElementById('rock-form').dataset.lng);

                alert(`üîç Location data - Lat: ${lat}, Lng: ${lng}`);

                alert('üîç About to save rock...');

                saveRock({
                    name: name,
                    description: description,
                    ownerName: ownerName,
                    lat: lat,
                    lng: lng,
                    photo: selectedPhoto
                });

                // Close modal and reset
                closeAddRockModal();
            });

            // Cancel button
            document.getElementById('cancel-add').addEventListener('click', function() {
                closeAddRockModal();
            });
        });

        function openAddRockModal(lat, lng) {
            document.getElementById('rock-form').dataset.lat = lat;
            document.getElementById('rock-form').dataset.lng = lng;
            document.getElementById('add-rock-modal').classList.remove('hidden');

            // Reset form
            document.getElementById('rock-form').reset();
            selectedPhoto = null;
            document.getElementById('photo-preview').classList.add('hidden');
        }

        function closeAddRockModal() {
            document.getElementById('add-rock-modal').classList.add('hidden');

            // Reset add rock mode
            addRockMode = false;
            const addBtn = document.getElementById('add-rock-mode');
            addBtn.textContent = '‚ûï Add Rock';
            addBtn.className = 'btn cherry';
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            console.log('üî• Page loaded, initializing...');
            initFirebase();
            setTimeout(initMap, 500);
        });
    </script>
</body>
</html>